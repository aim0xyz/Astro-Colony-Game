<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>🌌 Astro Colony - Crystal Mining Game</title>
<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  // 🔑 PUT YOUR FIREBASE CONFIG BELOW - Replace YOUR_... with your actual Firebase project details
  const firebaseConfig = {
    apiKey: "AIzaSyAwk0pIbza8wo22FTHr4Y3unZozmoJBmEg",
    authDomain: "astro-colony-game.firebaseapp.com",
    projectId: "astro-colony-game",
    storageBucket: "astro-colony-game.firebasestorage.app",
    messagingSenderId: "769632164161",
    appId: "1:769632164161:web:6fa1f148e5165477d1a9c0",
    measurementId: "G-XGB57PFGXJ"
  };

  // Init Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  window.firebaseAuth = auth;
  window.firebaseDb = db;
  window.gameState = {};
  window.dom = {}; // Initialize window.dom here, will be populated in initializeGame

  // --- DOM Elements ---
  const authContainer = document.getElementById('authContainer');
  const gameContainer = document.getElementById('gameContainer');
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const loginEmail = document.getElementById('loginEmail');
  const loginPassword = document.getElementById('loginPassword');
  const registerEmail = document.getElementById('registerEmail');
  const registerPassword = document.getElementById('registerPassword');
  const showRegisterBtn = document.getElementById('showRegister');
  const showLoginBtn = document.getElementById('showLogin');
  const logoutBtn = document.getElementById('logoutBtn');
  const userStatus = document.getElementById('userStatus');
  const profileBtn = document.getElementById('profileBtn');

  // Profile Modal
  const profileModal = document.getElementById('profileModal');
  const closeModalProfile = document.getElementById('closeModalProfile');
  const profileEmailDisplay = document.getElementById('profileEmailDisplay');
  const usernameInput = document.getElementById('usernameInput');
  const saveUsernameBtn = document.getElementById('saveUsernameBtn');

  // --- Auto-save ---
  let autoSaveIntervalId = null;
  const AUTO_SAVE_INTERVAL = 10 * 1000; // Save every 10 seconds

  function startAutoSave() {
    if (!autoSaveIntervalId) {
      autoSaveIntervalId = setInterval(saveGame, AUTO_SAVE_INTERVAL);
      console.log("Auto-saved!"); // Keeping console log for debug, removed user notification
    }
  }
  function stopAutoSave() {
    if (autoSaveIntervalId) {
      clearInterval(autoSaveIntervalId);
      autoSaveIntervalId = null;
      console.log("Auto-save stopped.");
    }
  }

  // --- Auth Functions ---
  async function register() {
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, registerEmail.value, registerPassword.value);
      showNotification("Registered & Logged in as " + userCredential.user.email, true, 'system');
    } catch (error) {
      showNotification("Registration failed: " + error.message, false, 'system');
    }
  }
  async function login() {
    try {
      await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
      showNotification("Logged in!", true, 'system');
    } catch (error) {
      showNotification("Login failed: " + error.message, false, 'system');
    }
  }
  async function logout() {
    try { await signOut(auth); showNotification("Logged out.", true, 'system'); }
    catch (err) { showNotification("Logout failed: " + err.message, false, 'system'); }
  }

  // --- Profile Editing ---
  async function updateUsername() {
    const user = auth.currentUser;
    if (user) {
      const newUsername = usernameInput.value.trim();
      if (newUsername.length > 0) {
        try {
          await updateProfile(user, { displayName: newUsername });
          userStatus.textContent = `Logged in as: ${user.displayName}`;
          showNotification("Username updated!", true, 'system');
          closeProfileModal();
        } catch (err) {
          showNotification("Update failed: " + err.message, false, 'system');
        }
      } else {
        showNotification("Username cannot be empty.", false, 'system');
      }
    }
  }
  function openProfileModal() {
    const user = auth.currentUser;
    if (user) {
      profileEmailDisplay.textContent = user.email;
      usernameInput.value = user.displayName || '';
      profileModal.style.display = 'flex';
    }
  }
  function closeProfileModal() {
    profileModal.style.display = 'none';
  }

  // --- Save/Load GameState ---
  async function saveGame() {
    const user = auth.currentUser;
    if (!user) return;
    try {
      await setDoc(doc(db, "gamestates", user.uid), window.gameState);
      console.log("Auto-saved!"); // Keeping console log for debug, removed user notification
    } catch (err) {
      console.error("Save failed:", err);
    }
  }
  async function loadGame(userId) {
    try {
      const snap = await getDoc(doc(db, "gamestates", userId));
      if (snap.exists()) {
        window.gameState = snap.data();
        initializeGame(true);
        showNotification("Game loaded!", true, 'system');
      } else {
        initializeGame(false); // No saved game, start new
      }
    } catch (err) {
      console.error("Error loading game:", err);
      initializeGame(false); // Error loading, start new
    }
  }

  // --- Auth State Change ---
  onAuthStateChanged(auth, (user) => {
    if (user) {
      userStatus.textContent = `Logged in as: ${user.displayName || user.email}`;
      authContainer.style.display = 'none';
      gameContainer.style.display = 'block';
      loadGame(user.uid);
      startAutoSave();
    } else {
      userStatus.textContent = 'Not logged in';
      authContainer.style.display = 'block';
      gameContainer.style.display = 'none';
      stopAutoSave();
      initializeGame(false); // Clear game state for anonymous users
    }
  });

  // --- Listeners ---
  loginForm.addEventListener('submit', (e)=>{e.preventDefault();login();});
  registerForm.addEventListener('submit', (e)=>{e.preventDefault();register();});
  logoutBtn.addEventListener('click', logout);
  showRegisterBtn.addEventListener('click', ()=>{loginForm.style.display='none';registerForm.style.display='block';});
  showLoginBtn.addEventListener('click', ()=>{loginForm.style.display='block';registerForm.style.display='none';});

  profileBtn.addEventListener('click', openProfileModal);
  closeModalProfile.addEventListener('click', closeProfileModal);
  saveUsernameBtn.addEventListener('click', updateUsername);
  profileModal.addEventListener('click',(e)=>{if(e.target===profileModal)closeProfileModal()});

  document.addEventListener('visibilitychange', ()=> {
    if(document.hidden && auth.currentUser) saveGame();
  });

  // --- Core Game Functions ---

  function plantCostPer(){return Math.max(10-window.gameState.upgrades.drone.level,2);}

  // Modified plantSeed to return cost (or 0 if failed). Only notifies for manual actions.
  function plantSeed(p){
      const cost = plantCostPer();
      if(!p || p.state !== 'empty' || window.gameState.gold < cost) return 0; // Return 0 if cannot plant

      p.state = 'planted';
      p.plantTime = Date.now();
      p.growthDuration = Math.max(3000, 30000 / window.gameState.upgrades.growth.level * (1 - 0.1 * window.gameState.research.deep));
      window.gameState.gold -= cost;

      // Only show notification if not auto-deploying (manual action)
      if (!window.gameState.autoDeploy) {
          showNotification("🛰️ Drone deployed!", true, 'manual');
      }
      return cost; // Return the cost for consolidation
  }

  // Modified harvestPlot to return crystal and gold gain. Only notifies for manual actions.
  function harvestPlot(p){
      if(p.state !== 'ready') return { cpGain: 0, goldGain: 0 }; // Return 0 if not ready

      let base = 15;
      let mul = window.gameState.upgrades.yield.level + window.gameState.upgrades.storage.level * 0.2;
      let luck = Math.random() < 0.1 * window.gameState.upgrades.luck.level ? 2 : 1;
      let cpGain = Math.floor(base * mul * luck);
      let goldGain = Math.floor(cpGain / 2);

      window.gameState.applePoints += cpGain;
      window.gameState.gold += goldGain;
      p.state = 'empty';
      p.plantTime = null;

      // Only show notification if not auto-harvesting (manual action)
      if (!window.gameState.autoDeploy) {
          showNotification(`${luck > 1 ? '🌠' : '💎'} +${cpGain} CP`, luck > 1, 'manual');
      }
      return { cpGain: cpGain, goldGain: goldGain }; // Return the gains for consolidation
  }

  function plantAll(){
      window.gameState.plots.forEach(p=>{plantSeed(p);});
      updateUI();
  }
  function harvestAll(){
      window.gameState.plots.forEach(p=>{harvestPlot(p);});
      updateUI();
  }

  function buyUpgrade(type){
      if(window.gameState.gold<window.gameState.upgrades[type].cost)return;
      window.gameState.gold-=window.gameState.upgrades[type].cost;
      window.gameState.upgrades[type].level++;
      window.gameState.upgrades[type].cost=Math.floor(window.gameState.upgrades[type].cost*1.5);
      showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} upgraded!`,true,'purchase');
      updateUI();
  }
  function buyResearch(type){
      if(window.gameState.applePoints<window.gameState.research[type+'Cost'])return;
      window.gameState.applePoints-=window.gameState.research[type+'Cost'];
      window.gameState.research[type]++;
      window.gameState.research[type+'Cost']=Math.floor(window.gameState.research[type+'Cost']*2.5);
      showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} Research complete!`,true,'purchase');
      if(type==='plots'){addPlot();}
      updateUI();
  }
  function addPlot(){
      window.gameState.plots.push({id:window.gameState.plots.length,state:'empty'});
      let newPlot=document.createElement('div');
      newPlot.className='plot empty';newPlot.id=`plot-${window.gameState.plots.length-1}`;
      newPlot.innerHTML='<div class="crop"></div><div class="progress-bar"><div class="progress-fill"></div></div>';
      newPlot.addEventListener('click',()=>handlePlot(window.gameState.plots.length-1));
      window.dom.farmGrid.appendChild(newPlot);
  }

  function buyAutoDeploy(){
      if(window.gameState.gold<5000)return;
      window.gameState.gold-=5000;
      window.gameState.autoDeploy=true;
      showNotification("Autonomous Drone AI activated!",true,'purchase');
      updateUI();
  }
  function exchangeCP(amount){
      if(window.gameState.applePoints<amount)return;
      let goldGain=Math.floor(amount*calcRate());
      window.gameState.applePoints-=amount;
      window.gameState.gold+=goldGain;
      showNotification(`Exchanged ${amount} CP for ${goldGain} Gold!`,true,'exchange');
      updateUI();
  }
  function exchangeCPMax(){
    let max = Math.floor(window.gameState.applePoints / 100) * 100;
    if (max > 0) {
      exchangeCP(max);
    }
  }

  function calcRate(){
      let rate=0.5;
      rate+=window.gameState.research.trade*0.05;
      if(Date.now()<window.gameState.marketCrashUntil)rate*=0.25;
      if(Date.now()<window.gameState.boomUntil)rate*=2.0;
      return rate.toFixed(2);
  }

  // MODIFIED updatePlots to handle auto-deploy and consolidated notifications, governed by notification settings
  function updatePlots(){
      let elems = window.dom.farmGrid.querySelectorAll('.plot');
      window.gameState.plots.forEach((p,i)=>{
          let el=elems[i],crop=el.querySelector('.crop');
          crop.textContent=(p.state==='empty'?'🛰️':p.state==='planted'?'⛏️':'💎');
          el.className=`plot ${p.state}`;
          let bar=el.querySelector('.progress-bar');bar.style.display=p.state==='planted'?'block':'none';
          if(p.state==='planted'){
              let prog=Math.min(100,(Date.now()-p.plantTime)/p.growthDuration*100);
              el.querySelector('.progress-fill').style.width=prog+'%';
              if(Date.now()-p.plantTime>=p.growthDuration)p.state='ready';
          }
      });

      // Auto-deploy logic with consolidated notifications
      if(window.gameState.autoDeploy){
          let autoHarvestedCP = 0;
          let autoHarvestedGold = 0;
          let autoPlantedCount = 0;

          // Auto-harvest any ready plots
          window.gameState.plots.filter(p => p.state === 'ready').forEach(p => {
              const result = harvestPlot(p); // Harvest, but harvestPlot suppresses manual notifications when autoDeploy is true
              autoHarvestedCP += result.cpGain;
              autoHarvestedGold += result.goldGain;
          });

          // Auto-plant any empty plots
          window.gameState.plots.filter(p => p.state === 'empty').forEach(p => {
              const cost = plantSeed(p); // Plant, but plantSeed suppresses manual notifications when autoDeploy is true
              if (cost > 0) { // Check if planting was successful
                  autoPlantedCount++;
              }
          });

          // Show consolidated notifications for auto-actions only if user enabled 'auto' notifications
          if (autoHarvestedCP > 0 && window.gameState.notificationSettings && window.gameState.notificationSettings.auto) {
              showNotification(`🤖 Auto-collected ${autoHarvestedCP} CP!`, true, 'auto');
          }
          if (autoPlantedCount > 0 && window.gameState.notificationSettings && window.gameState.notificationSettings.auto) {
               showNotification(`🤖 Auto-deployed ${autoPlantedCount} drones!`, true, 'auto');
          }
      }
  }

  function handlePlot(index){
      let p=window.gameState.plots[index];
      if(p.state==='empty'){plantSeed(p);}
      else if(p.state==='ready'){harvestPlot(p);}
      updateUI();
  }

  // MODIFIED updateUI to hide/show action buttons
  function updateUI(){
    window.dom.applePoints.textContent=window.gameState.applePoints;window.dom.gold.textContent=window.gameState.gold;
    let rate=calcRate();window.dom.exchangeRate.textContent=rate;
    if(Date.now()<window.gameState.marketCrashUntil){let rem=window.gameState.marketCrashUntil-Date.now();window.dom.crashTimer.textContent=`⚠️ Crash ends in ${Math.floor(rem/60000)}m ${Math.floor((rem%60000)/1000)}s`;window.dom.crashTimer.className='crash';}
    else if(Date.now()<window.gameState.boomUntil){let rem=window.gameState.boomUntil-Date.now();window.dom.crashTimer.textContent=`🚀 Boom ends in ${Math.floor(rem/60000)}m ${Math.floor((rem%60000)/1000)}s`;window.dom.crashTimer.className='boom';}
    else window.dom.crashTimer.textContent="";

    window.dom.growthUpgradeBtn.textContent=`Upgrade (${window.gameState.upgrades.growth.cost} cr)`;window.dom.growthLevel.textContent=window.gameState.upgrades.growth.level;window.dom.growthUpgradeBtn.disabled=window.gameState.gold<window.gameState.upgrades.growth.cost;
    window.dom.yieldUpgradeBtn.textContent=`Upgrade (${window.gameState.upgrades.yield.cost} cr)`;window.dom.yieldLevel.textContent=window.gameState.upgrades.yield.level;window.dom.yieldUpgradeBtn.disabled=window.gameState.gold<window.gameState.upgrades.yield.cost;
    window.dom.luckUpgradeBtn.textContent=`Upgrade (${window.gameState.upgrades.luck.cost} cr)`;window.dom.luckLevel.textContent=window.gameState.upgrades.luck.level;window.dom.luckUpgradeBtn.disabled=window.gameState.gold<window.gameState.upgrades.luck.cost;
    window.dom.droneUpgradeBtn.textContent=`Upgrade (${window.gameState.upgrades.drone.cost} cr)`;window.dom.droneLevel.textContent=window.gameState.upgrades.drone.level;window.dom.droneUpgradeBtn.disabled=window.gameState.gold<window.gameState.upgrades.drone.cost;
    window.dom.storageUpgradeBtn.textContent=`Upgrade (${window.gameState.upgrades.storage.cost} cr)`;window.dom.storageLevel.textContent=window.gameState.upgrades.storage.level;window.dom.storageUpgradeBtn.disabled=window.gameState.gold<window.gameState.upgrades.storage.cost;
    window.dom.researchPlotBtn.textContent=`Research (${window.gameState.research.plotsCost} CP)`;window.dom.researchPlots.textContent=window.gameState.research.plots;window.dom.researchPlotBtn.disabled=window.gameState.applePoints<window.gameState.research.plotsCost;
    window.dom.deepUpgradeBtn.textContent=`Research (${window.gameState.research.deepCost} CP)`;window.dom.deepLevel.textContent=window.gameState.research.deep;window.dom.deepUpgradeBtn.disabled=window.gameState.applePoints<window.gameState.research.deepCost;
    window.dom.tradeUpgradeBtn.textContent=`Research (${window.gameState.research.tradeCost} CP)`;window.dom.tradeLevel.textContent=window.gameState.research.trade;window.dom.tradeUpgradeBtn.disabled=window.gameState.applePoints<window.gameState.research.tradeCost;
    window.dom.exchangeBtn.disabled=window.gameState.applePoints<100;window.dom.exchange1000Btn.disabled=window.gameState.applePoints<1000;window.dom.exchangeMaxBtn.disabled=window.gameState.applePoints<100;
    window.dom.autoDeployBtn.disabled=window.gameState.autoDeploy||window.gameState.gold<5000;window.dom.autoDeployBtn.textContent=window.gameState.autoDeploy?"Purchased ✓":"Buy (5000 cr)";

    // --- NEW LOGIC FOR HIDING/SHOWING PLANT/HARVEST BUTTONS ---
    if (window.gameState.autoDeploy) {
        window.dom.gameActionButtons.style.display = 'none'; // Hide the entire controls div
    } else {
        window.dom.gameActionButtons.style.display = 'grid'; // Show as grid (its default CSS display)
        // Only apply disabled logic if buttons are visible (autoDeploy is false)
        let empties = window.gameState.plots.filter(p=>p.state==='empty').length;
        window.dom.plantCost.textContent=empties*plantCostPer();
        window.dom.plantAllBtn.disabled=(empties===0||window.gameState.gold<empties*plantCostPer());
        window.dom.harvestAllBtn.disabled=window.gameState.plots.every(p=>p.state!=='ready');
    }

    // Update notification UI toggles (if present)
    if(window.dom.notifManual) window.dom.notifManual.checked = !!window.gameState.notificationSettings.manual;
    if(window.dom.notifAuto) window.dom.notifAuto.checked = !!window.gameState.notificationSettings.auto;
    if(window.dom.notifMarket) window.dom.notifMarket.checked = !!window.gameState.notificationSettings.market;
    if(window.dom.notifPurchase) window.dom.notifPurchase.checked = !!window.gameState.notificationSettings.purchase;
    if(window.dom.notifExchange) window.dom.notifExchange.checked = !!window.gameState.notificationSettings.exchange;
    if(window.dom.notifSystem) window.dom.notifSystem.checked = !!window.gameState.notificationSettings.system;
  }

  let gameLoopInterval;
  function updateGame(){
      let now=Date.now();
      let delta=now-window.gameState.lastDayTick;
      if(delta>=1000){ // Tick every second
          window.gameState.lastDayTick=now;
          updatePlots();
          updateUI();
      }
      // Season logic (every 30 days for simplicity, about 30 seconds if tick is 1s)
      if(now>=window.gameState.seasonEndTime){
        window.gameState.seasonDay++;
        window.gameState.seasonEndTime = now + 30 * 1000; // Next season in 30 seconds
        showNotification(`Day ${window.gameState.seasonDay}!`, true, 'system');

        // Random market events
        let rand = Math.random();
        if(rand < 0.1) { // 10% chance of crash
            window.gameState.marketCrashUntil = now + 15 * 1000; // 15s crash
            showNotification("Market Crash!", false, 'market');
        } else if (rand < 0.2) { // 10% chance of boom
            window.gameState.boomUntil = now + 15 * 1000; // 15s boom
            showNotification("Market Boom!", true, 'market');
        }
      }
      window.dom.seasonDay.textContent=window.gameState.seasonDay;
      window.dom.seasonTimer.textContent=`Next event in ${Math.floor((window.gameState.seasonEndTime-now)/1000)}s`;
  }

  function initializeGame(loaded) {
    if (!loaded) {
      window.gameState = {applePoints:0,gold:100,plotsOwned:4,plots:[],autoDeploy:false,
        upgrades:{growth:{level:1,cost:500},yield:{level:1,cost:750},luck:{level:1,cost:1000},drone:{level:1,cost:1200},storage:{level:1,cost:1500}},
        research:{plots:0,plotsCost:2000,deep:0,deepCost:3000,trade:0,tradeCost:5000},
        seasonDay:1,seasonEndTime:Date.now()+30*1000,lastDayTick:Date.now(), // 30 seconds for a "day" for testing
        marketCrashUntil:0,boomUntil:0,
        // Notification settings defaults:
        notificationSettings: { manual: true, auto: false, market: true, purchase: true, exchange: true, system: true }
      };
      for(let i=0;i<window.gameState.plotsOwned;i++){window.gameState.plots.push({id:i,state:'empty'});}
    } else {
      // Ensure notificationSettings exist after load
      if(!window.gameState.notificationSettings) {
        window.gameState.notificationSettings = { manual: true, auto: false, market: true, purchase: true, exchange: true, system: true };
      }
    }

    // Re-assign dom elements to window.dom as they might be called before all are set
    // This is crucial for initial setup and after loading a game state
    window.dom = {
        gameContainer:document.getElementById('gameContainer'),
        farmGrid:document.getElementById('farmGrid'),
        applePoints:document.getElementById('applePoints'),
        gold:document.getElementById('gold'),
        plantCost:document.getElementById('plantCost'),
        seasonDay:document.getElementById('seasonDay'),
        seasonTimer:document.getElementById('seasonTimer'),

        growthLevel:document.getElementById('growthLevel'),growthUpgradeBtn:document.getElementById('growthUpgradeBtn'),
        yieldLevel:document.getElementById('yieldLevel'),yieldUpgradeBtn:document.getElementById('yieldUpgradeBtn'),
        luckLevel:document.getElementById('luckLevel'),luckUpgradeBtn:document.getElementById('luckUpgradeBtn'),
        droneLevel:document.getElementById('droneLevel'),droneUpgradeBtn:document.getElementById('droneUpgradeBtn'),
        storageLevel:document.getElementById('storageLevel'),storageUpgradeBtn:document.getElementById('storageUpgradeBtn'),
        autoDeployBtn:document.getElementById('autoDeployBtn'),

        researchPlots:document.getElementById('researchPlots'),researchPlotBtn:document.getElementById('researchPlotBtn'),
        deepLevel:document.getElementById('deepLevel'),deepUpgradeBtn:document.getElementById('deepUpgradeBtn'),
        tradeLevel:document.getElementById('tradeLevel'),tradeUpgradeBtn:document.getElementById('tradeTradeBtn'),

        // exchangeRate moved into the exchange section in the HTML
        exchangeRate:document.getElementById('exchangeRate'),
        exchangeBtn:document.getElementById('exchangeBtn'),exchange1000Btn:document.getElementById('exchange1000Btn'),exchangeMaxBtn:document.getElementById('exchangeMaxBtn'),

        plantAllBtn:document.getElementById('plantAllBtn'),
        harvestAllBtn:document.getElementById('harvestAllBtn'),
        crashTimer:document.getElementById('crashTimer'),
        gameActionButtons:document.getElementById('gameActionButtons'),

        // Notification toggles
        notifManual:document.getElementById('notifManual'),
        notifAuto:document.getElementById('notifAuto'),
        notifMarket:document.getElementById('notifMarket'),
        notifPurchase:document.getElementById('notifPurchase'),
        notifExchange:document.getElementById('notifExchange'),
        notifSystem:document.getElementById('notifSystem')
    };

    // Set up event listeners for newly rendered elements (plots) or re-bind if game loaded
    // Remove listeners first to prevent duplicates on game load
    try { window.dom.plantAllBtn.removeEventListener('click', plantAll); } catch(e){}
    try { window.dom.harvestAllBtn.removeEventListener('click', harvestAll); } catch(e){}
    try { window.dom.growthUpgradeBtn.removeEventListener('click', () => buyUpgrade('growth')); } catch(e){}
    try { window.dom.yieldUpgradeBtn.removeEventListener('click', () => buyUpgrade('yield')); } catch(e){}
    try { window.dom.luckUpgradeBtn.removeEventListener('click', () => buyUpgrade('luck')); } catch(e){}
    try { window.dom.droneUpgradeBtn.removeEventListener('click', () => buyUpgrade('drone')); } catch(e){}
    try { window.dom.storageUpgradeBtn.removeEventListener('click', () => buyUpgrade('storage')); } catch(e){}
    try { window.dom.autoDeployBtn.removeEventListener('click', buyAutoDeploy); } catch(e){}
    try { window.dom.researchPlotBtn.removeEventListener('click', () => buyResearch('plots')); } catch(e){}
    try { window.dom.deepUpgradeBtn.removeEventListener('click', () => buyResearch('deep')); } catch(e){}
    try { window.dom.tradeUpgradeBtn.removeEventListener('click', () => buyResearch('trade')); } catch(e){}
    try { window.dom.exchangeBtn.removeEventListener('click', () => exchangeCP(100)); } catch(e){}
    try { window.dom.exchange1000Btn.removeEventListener('click', () => exchangeCP(1000)); } catch(e){}
    try { window.dom.exchangeMaxBtn.removeEventListener('click', exchangeCPMax); } catch(e){}

    // Add listeners
    window.dom.plantAllBtn.addEventListener('click', plantAll);
    window.dom.harvestAllBtn.addEventListener('click', harvestAll);
    window.dom.growthUpgradeBtn.addEventListener('click', () => buyUpgrade('growth'));
    window.dom.yieldUpgradeBtn.addEventListener('click', () => buyUpgrade('yield'));
    window.dom.luckUpgradeBtn.addEventListener('click', () => buyUpgrade('luck'));
    window.dom.droneUpgradeBtn.addEventListener('click', () => buyUpgrade('drone'));
    window.dom.storageUpgradeBtn.addEventListener('click', () => buyUpgrade('storage'));
    window.dom.autoDeployBtn.addEventListener('click', buyAutoDeploy);
    window.dom.researchPlotBtn.addEventListener('click', () => buyResearch('plots'));
    window.dom.deepUpgradeBtn.addEventListener('click', () => buyResearch('deep'));
    window.dom.tradeUpgradeBtn.addEventListener('click', () => buyResearch('trade'));
    window.dom.exchangeBtn.addEventListener('click', () => exchangeCP(100));
    window.dom.exchange1000Btn.addEventListener('click', () => exchangeCP(1000));
    window.dom.exchangeMaxBtn.addEventListener('click', exchangeCPMax);

    // Notification toggles listeners
    if(window.dom.notifManual) {
      window.dom.notifManual.checked = !!window.gameState.notificationSettings.manual;
      window.dom.notifManual.addEventListener('change', ()=>{
        window.gameState.notificationSettings.manual = !!window.dom.notifManual.checked;
        saveGame();
      });
    }
    if(window.dom.notifAuto) {
      window.dom.notifAuto.checked = !!window.gameState.notificationSettings.auto;
      window.dom.notifAuto.addEventListener('change', ()=>{
        window.gameState.notificationSettings.auto = !!window.dom.notifAuto.checked;
        saveGame();
      });
    }
    if(window.dom.notifMarket) {
      window.dom.notifMarket.checked = !!window.gameState.notificationSettings.market;
      window.dom.notifMarket.addEventListener('change', ()=>{
        window.gameState.notificationSettings.market = !!window.dom.notifMarket.checked;
        saveGame();
      });
    }
    if(window.dom.notifPurchase) {
      window.dom.notifPurchase.checked = !!window.gameState.notificationSettings.purchase;
      window.dom.notifPurchase.addEventListener('change', ()=>{
        window.gameState.notificationSettings.purchase = !!window.dom.notifPurchase.checked;
        saveGame();
      });
    }
    if(window.dom.notifExchange) {
      window.dom.notifExchange.checked = !!window.gameState.notificationSettings.exchange;
      window.dom.notifExchange.addEventListener('change', ()=>{
        window.gameState.notificationSettings.exchange = !!window.dom.notifExchange.checked;
        saveGame();
      });
    }
    if(window.dom.notifSystem) {
      window.dom.notifSystem.checked = !!window.gameState.notificationSettings.system;
      window.dom.notifSystem.addEventListener('change', ()=>{
        window.gameState.notificationSettings.system = !!window.dom.notifSystem.checked;
        saveGame();
      });
    }

    // Clear existing plots and re-render based on current gameState
    window.dom.farmGrid.innerHTML = '';
    window.gameState.plots.forEach(p => {
        let plotEl = document.createElement('div');
        plotEl.className = `plot ${p.state}`;
        plotEl.id = `plot-${p.id}`;
        plotEl.innerHTML = '<div class="crop"></div><div class="progress-bar"><div class="progress-fill"></div></div>';
        plotEl.addEventListener('click', () => handlePlot(p.id));
        window.dom.farmGrid.appendChild(plotEl);
    });

    if(gameLoopInterval) clearInterval(gameLoopInterval);
    gameLoopInterval = setInterval(updateGame, 100); // 100ms interval for smoother updates

    updateUI(); // Initial UI update
  }


  // --- Notify helper ---
  // showNotification now respects user notificationSettings via a 'type' string.
  // Types: 'manual', 'auto', 'market', 'purchase', 'exchange', 'system'
  function showNotification(msg, lucky=false, type='manual'){
    // Ensure defaults exist in case this is called before initializeGame
    if(!window.gameState) window.gameState = {};
    if(!window.gameState.notificationSettings){
      window.gameState.notificationSettings = { manual: true, auto: false, market: true, purchase: true, exchange: true, system: true };
    }
    // If user disabled this notification type, skip
    if(type && window.gameState.notificationSettings && window.gameState.notificationSettings[type] === false) return;

    let n=document.createElement('div');
    n.className=`notification ${lucky?'lucky':''}`;
    n.textContent=msg;
    document.getElementById('notificationContainer').appendChild(n);
    setTimeout(()=>n.classList.add('show'),20);
    setTimeout(()=>n.classList.remove('show'),3000);
    setTimeout(()=>n.remove(),3500);
  }
</script>

<style>
  /* 8-bit / Pixel-art Styles */
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

  html,body {
    height: 100%;
    margin: 0;
    padding: 0;
  }

  body{
    background: linear-gradient(180deg,#07102a 0%, #0b0b1a 100%);
    color:#00ffea;
    font-family:'Press Start 2P', monospace;
    font-size:12px;
    padding:12px;
    image-rendering: pixelated;
    -webkit-font-smoothing: none;
    -moz-osx-font-smoothing: grayscale;
  }

  .game-container{
    max-width:1000px;
    margin:10px auto;
    background:#081028;
    border:6px solid #00ffea;
    padding:12px;
    box-sizing:border-box;
    box-shadow: 0 0 0 4px #002631 inset;
  }

  /* Buttons: chunky square style */
  .btn{
    background:#00ffea;
    color:#001b18;
    font-weight:bold;
    border:3px solid #002631;
    padding:10px;
    cursor:pointer;
    font-family:'Press Start 2P',monospace;
    font-size:11px;
    text-align:center;
    display:block;
    width:100%;
    box-sizing:border-box;
    margin-bottom:6px;
    border-radius:0; /* square corners for 8-bit look */
    box-shadow: 4px 4px 0 #001b18;
    line-height:1.1;
  }
  .btn:hover:enabled{ background:#b7fff0; }
  .btn:disabled{ background:#444;color:#888;border-color:#111;box-shadow:none;cursor:not-allowed; }

  /* Notification Styles: blocky */
  .notification-container{
    position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:1000;pointer-events:none;display:flex;flex-direction:column;gap:6px;
  }
  .notification{
    background:#00ffea;
    color:#00231f;
    border:4px solid #002631;
    padding:10px 16px;
    font-size:12px;
    opacity:0;
    transform: translateY(-20px);
    transition: opacity 0.2s linear, transform 0.2s linear;
    box-shadow: 4px 4px 0 #001b18;
    white-space:nowrap;
    border-radius:0;
  }
  .notification.show{ opacity:1; transform: translateY(0); }
  .notification.lucky{ background:#ffb24a; border-color:#7a3f00; color:#100700; }

  /* Modal Styles: blocky */
  .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.75);display:none;justify-content:center;align-items:center;z-index:1001;}
  .modal-content{background:#001420;padding:20px;border:4px solid #00ffea;max-width:420px;text-align:center;position:relative;border-radius:0;box-shadow:0 0 0 6px rgba(0,255,234,0.08);}
  .modal-content h2{color:#00ffea;margin-bottom:10px;font-size:14px;}
  .modal-content button#closeModalProfile{position:absolute;top:6px;right:6px;background:#ff4444;color:#fff;border:none;padding:6px;cursor:pointer;font-size:12px;border-radius:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;}
  .modal-content input[type="text"]{width:calc(100% - 20px);padding:8px;margin-bottom:10px;border:2px solid #00ffea;background:#061021;color:#fff;font-family:'Press Start 2P',monospace;font-size:12px;border-radius:0;}

  /* Game Specific Styles */
  .header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding: 6px;
    background: #020616;
    border-bottom: 3px solid #00ffea;
  }
  .status-info { display:flex; gap: 10px; align-items:center; }
  .status-item { font-size: 10px; color: #b9fff2; }
  .farm-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 10px;
    padding: 10px;
    border: 4px solid #00ffea;
    background: #02061a;
    min-height: 200px;
    border-radius: 0;
  }
  .plot {
    position: relative;
    width: 80px;
    height: 80px;
    background: #001016;
    border: 4px solid #00f6ff;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 30px;
    cursor: pointer;
    transition: transform 0.07s ease-in-out;
    box-shadow: 4px 4px 0 #001b18;
    border-radius: 0;
  }
  .plot:hover { transform: scale(1.04); }
  .plot.planted .progress-bar { display: block; }
  .plot.ready { border-color: #00ffea; background: #002b19; }
  .plot.empty .crop:before { content: "✨"; }
  .plot.planted .crop:before { content: "⛏️"; }
  .plot.ready .crop:before { content: "💎"; }
  .progress-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 6px; background: rgba(0,0,0,0.6); display: none; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
  .progress-fill { height: 100%; background: #00f6ff; width: 0%; }

  .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; }
  .section { border: 4px solid #00ffea; padding: 10px; margin-top: 10px; border-radius: 0; background:#00121f; }
  .section h3 { color: #00f6ff; text-align: center; margin-top: 0; font-size: 14px; }

  .upgrade-grid, .research-grid, .exchange-grid { display: grid; grid-template-columns: 1fr; gap: 6px; }
  @media (min-width: 600px) {
    .upgrade-grid { grid-template-columns: repeat(2, 1fr); }
    .research-grid { grid-template-columns: repeat(3, 1fr); }
    .exchange-grid { grid-template-columns: repeat(3, 1fr); }
  }
  .upgrade-item, .research-item { display:flex; justify-content:space-between; align-items:center; padding:6px; border:2px solid #00f6ff; background:#00121a; border-radius:0; }

  .crash { color: #ff4444; font-weight: bold; }
  .boom { color: #00ffea; font-weight: bold; }

  /* Notification toggles */
  .notif-row { display:flex; gap:8px; align-items:center; padding:6px; }
  .notif-row input[type="checkbox"]{ width:18px; height:18px; transform:scale(1.0); }

  /* Authentication Specific Styles */
  #authContainer {
    max-width: 420px;
    margin: 50px auto;
    padding: 20px;
    background: #001226;
    border: 6px solid #00ffea;
    text-align: center;
    border-radius: 0;
  }
  #authContainer input {
    width: calc(100% - 20px);
    padding: 10px;
    margin-bottom: 10px;
    border: 2px solid #00f6ff;
    background: #021126;
    color: #bffef1;
    font-family: 'Press Start 2P', monospace;
    font-size: 12px;
    border-radius: 0;
  }
  #authContainer .btn { margin-top: 10px; }
  #authContainer p { margin-top: 15px; font-size: 10px; color:#9ff7ef; }

  /* Small tweaks */
  .status p { margin: 6px 0; color:#bffef1; font-size:12px; }
  .status { margin-bottom: 8px; }

</style>
</head>
<body>

<!-- Auth UI -->
<div id="authContainer">
  <h2 style="color:#00f6ff;">Astro Colony</h2>
  <form id="loginForm">
    <input type="email" id="loginEmail" placeholder="Email" required>
    <input type="password" id="loginPassword" placeholder="Password" required>
    <button type="submit" class="btn">Login</button>
  </form>
  <p>Don't have an account? <button class="btn" id="showRegister">Register</button></p>
  <form id="registerForm" style="display:none;">
    <input type="email" id="registerEmail" placeholder="Email" required>
    <input type="password" id="registerPassword" placeholder="Password" required>
    <button type="submit" class="btn">Register</button>
  </form>
  <p>Already have an account? <button class="btn" id="showLogin">Login</button></p>
</div>

<!-- Game UI -->
<div class="game-container" id="gameContainer" style="display:none;">
  <div class="header-bar">
    <h1>🌌 Astro Colony</h1>
    <div class="status-info">
      <span class="status-item" id="userStatus">Not logged in</span>
      <button class="btn" id="profileBtn" style="width:auto; padding:5px 10px; font-size:10px; margin-bottom:0;">👤 Profile</button>
      <button class="btn" id="logoutBtn" style="width:auto; padding:5px 10px; font-size:10px; margin-bottom:0;">🚪 Logout</button>
    </div>
  </div>

  <div class="status">
    <p>Crystals: <span id="applePoints">0</span> | Gold: <span id="gold">0</span> cr</p>
    <p>Day: <span id="seasonDay">1</span> (<span id="seasonTimer"></span>)</p>
    <p id="marketStatus"><span id="crashTimer"></span></p>
  </div>

  <div class="farm-grid" id="farmGrid">
    <!-- Plots will be dynamically added here by JavaScript -->
  </div>

  <!-- Action buttons: Hide this div when autoDeploy is active -->
  <div class="controls" id="gameActionButtons">
    <button class="btn" id="plantAllBtn">Deploy All Drones (<span id="plantCost">0</span> cr)</button>
    <button class="btn" id="harvestAllBtn">Collect All Crystals</button>
  </div>

  <div class="section">
    <h3>🛠️ Upgrades</h3>
    <div class="upgrade-grid">
      <div class="upgrade-item">Growth Lvl: <span id="growthLevel">1</span> <button class="btn" id="growthUpgradeBtn">Upgrade</button></div>
      <div class="upgrade-item">Yield Lvl: <span id="yieldLevel">1</span> <button class="btn" id="yieldUpgradeBtn">Upgrade</button></div>
      <div class="upgrade-item">Luck Lvl: <span id="luckLevel">1</span> <button class="btn" id="luckUpgradeBtn">Upgrade</button></div>
      <div class="upgrade-item">Drone Lvl: <span id="droneLevel">1</span> <button class="btn" id="droneUpgradeBtn">Upgrade</button></div>
      <div class="upgrade-item">Storage Lvl: <span id="storageLevel">1</span> <button class="btn" id="storageUpgradeBtn">Upgrade</button></div>
      <button class="btn" id="autoDeployBtn">Buy Autonomous Drone AI (5000 cr)</button>
    </div>
  </div>

  <div class="section">
    <h3>🔬 Research</h3>
    <div class="research-grid">
      <div class="research-item">New Plots Lvl: <span id="researchPlots">0</span> <button class="btn" id="researchPlotBtn">Research</button></div>
      <div class="research-item">Deep Mining Lvl: <span id="deepLevel">0</span> <button class="btn" id="deepUpgradeBtn">Research</button></div>
      <div class="research-item">Trade Routes Lvl: <span id="tradeLevel">0</span> <button class="btn" id="tradeTradeBtn">Research</button></div>
    </div>
  </div>

  <div class="section">
    <h3>🔔 Notifications</h3>
    <div class="exchange-grid" style="grid-template-columns: repeat(2,1fr);">
      <label class="notif-row"><input type="checkbox" id="notifManual"> Manual Actions</label>
      <label class="notif-row"><input type="checkbox" id="notifAuto"> Auto Farming</label>
      <label class="notif-row"><input type="checkbox" id="notifMarket"> Market Events</label>
      <label class="notif-row"><input type="checkbox" id="notifPurchase"> Purchases/Upgrades</label>
      <label class="notif-row"><input type="checkbox" id="notifExchange"> Exchanges</label>
      <label class="notif-row"><input type="checkbox" id="notifSystem"> System</label>
    </div>
    <div style="color:#bffef1; margin-top:6px; font-size:11px;">Tip: Auto Farming notifications default to OFF to avoid spam.</div>
  </div>

  <div class="section">
    <h3>💰 Market Exchange</h3>
    <div class="exchange-grid">
      <button class="btn" id="exchangeBtn">Exchange 100 CP</button>
      <button class="btn" id="exchange1000Btn">Exchange 1000 CP</button>
      <button class="btn" id="exchangeMaxBtn">Exchange All CP</button>
      <div style="grid-column: 1 / -1; text-align:center; margin-top:6px; color:#bffef1;">Rate: <span id="exchangeRate">0.50</span> cr/CP</div>
    </div>
  </div>
</div>

<div class="notification-container" id="notificationContainer"></div>

<!-- Profile Modal -->
<div class="modal" id="profileModal">
  <div class="modal-content">
    <button id="closeModalProfile">✖</button>
    <h2>👤 Your Profile</h2>
    <p><strong>Email:</strong> <span id="profileEmailDisplay"></span></p>
    <p><strong>Username:</strong></p>
    <input type="text" id="usernameInput" placeholder="Enter a username">
    <button class="btn" id="saveUsernameBtn" style="width:100%;">Save Username</button>
  </div>
</div>

</body>
</html>