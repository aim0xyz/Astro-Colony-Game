<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>üåå Astro Colony - Crystal Mining Game</title>

<style>
  @font-face {font-family:'PixelFont'; src: url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');}
  *{box-sizing:border-box;margin:0;padding:0;}
  body{background:#0d0d2b;color:#fff;font-family:'PixelFont',monospace;font-size:12px;padding:10px;min-height:100vh;user-select:none;-webkit-user-select:none;}
  .game-container{max-width:1000px;margin:0 auto;background:#12123d;border:4px solid #00ffea;padding:10px;}
  .title{text-align:center;font-size:20px;color:#00f6ff;margin-bottom:8px;}
  .top-controls{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px;}
  .auth-area{display:flex;gap:8px;align-items:center;}
  .season-info{text-align:center;background:#1b1b47;border:2px solid #00ffea;padding:8px;margin:10px 0;}
  .stats-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:5px;background:#1f1f4f;border:2px solid #00ffea;padding:5px;margin-bottom:10px;}
  .stat{background:#0d0d2b;border:1px solid #00f6ff;padding:8px;text-align:center;}
  .stat-label{font-size:10px;color:#aaa;}
  .stat-value{font-size:16px;color:#0aff9d;}
  .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;margin-bottom:10px;}
  .btn{background:#0aff9d;color:#000;font-weight:bold;border:2px solid #00ffea;padding:10px;cursor:pointer;transition:0.2s;font-family:'PixelFont',monospace;}
  .btn:hover:enabled{background:#06c285;}
  .btn:disabled{background:#333;color:#888;border-color:#444;cursor:not-allowed;}
  .farm-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:6px;margin-bottom:15px;padding:6px;border:2px solid #00ffea;background:#0b1126;}
  .plot{width:64px;height:64px;background:#1b1b47;border:3px solid #00ffea;display:flex;align-items:center;justify-content:center;font-size:28px;transition:0.12s;position:relative;cursor:pointer;border-radius:4px;}
  .plot:hover{transform:scale(1.06);}
  .plot.ready{background:#2b0040;animation:glow 1s infinite alternate;}
  @keyframes glow{from{border-color:#ff00c8;}to{border-color:#00ffea;}}
  .crop{font-size:28px;}
  .progress-bar{position:absolute;bottom:3px;left:3px;right:3px;height:4px;background:#000;display:none;border-radius:3px;overflow:hidden;}
  .progress-fill{height:100%;background:#0aff9d;width:0;}
  .upgrades{background:#1f1f4f;border:2px solid #00ffea;padding:10px;margin-bottom:10px;border-radius:4px;}
  .upgrades h3{text-align:center;margin-bottom:8px;color:#0aff9d;}
  .upgrade-item{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;border:1px solid #00ffea;background:#0d0d2b;margin:5px 0;padding:6px;gap:6px;border-radius:3px;}
  .upgrade-text{flex:1;display:flex;align-items:center;gap:6px;}
  .upgrade-item .btn{min-width:120px;font-size:10px;padding:8px;}
  .info-btn{background:#00f6ff;color:#000;font-size:10px;border:1px solid #fff;cursor:pointer;border-radius:50%;width:20px;height:20px;line-height:18px;text-align:center;margin-left:5px;padding:0;}
  .exchange{background:#1f1f4f;border:2px solid #FFD700;padding:10px;border-radius:4px;}
  .exchange h3{text-align:center;color:#FFD700;margin-bottom:8px;}
  .exchange-buttons{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px;}
  #crashTimer{font-size:11px;margin-top:4px;text-align:center;}
  #crashTimer.crash{color:#ff4444;}
  #crashTimer.boom{color:#0af;}
  .notification-container{position:fixed;top:20px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;z-index:1000;gap:8px;}
  .notification{background:#0aff9d;color:#000;border:2px solid #00ffea;padding:8px 15px;font-size:12px;opacity:0;transform:translateY(-20px);transition:all .25s ease;white-space:nowrap;border-radius:4px;}
  .notification.show{opacity:1;transform:translateY(0);}
  .notification.lucky{background:#FFD700;color:#000;}
  .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:2000;}
  .modal-content{background:#222;color:#fff;padding:20px;border:2px solid #0aff9d;max-width:440px;text-align:center;position:relative;border-radius:6px;}
  .modal-content h2{margin-bottom:10px;color:#0aff9d;}
  .modal-content button.close-modal{position:absolute;top:8px;right:8px;background:#ff4444;color:#fff;border:none;padding:6px 8px;cursor:pointer;border-radius:4px;}
  /* Profile modal specifics */
  .profile-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;}
  .profile-grid label{font-size:12px;color:#bffef1;text-align:left;margin-bottom:4px;display:block;}
  .profile-grid input[type="text"], .profile-grid input[type="password"]{width:100%;padding:8px;border:1px solid #00f6ff;background:#061021;color:#fff;border-radius:4px;}
  .notif-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;}
  .muted{color:#74d8cc;font-size:11px;margin-top:6px;}
  /* small responsive tweaks */
  @media (max-width:720px){ .top-controls{flex-direction:column;align-items:flex-start;} .profile-grid{grid-template-columns:1fr;} .notif-grid{grid-template-columns:1fr;} .controls{grid-template-columns:1fr;} }
</style>
</head>
<body>

<div class="game-container" id="gameContainer">
  <!-- Title above auth / profile area -->
  <div class="title">üåå Astro Colony</div>

  <div class="top-controls">
    <div class="auth-area">
      <div id="authContainer">
        <form id="loginForm">
          <input id="loginEmail" type="email" placeholder="Email" required style="padding:6px;border-radius:4px;border:1px solid #00f6ff;background:#061021;color:#fff;margin-right:6px;">
          <input id="loginPassword" type="password" placeholder="Password" required style="padding:6px;border-radius:4px;border:1px solid #00f6ff;background:#061021;color:#fff;margin-right:6px;">
          <button class="btn" type="submit" style="padding:8px 10px;">Login</button>
        </form>
        <div id="authLinks" style="display:inline-block;margin-left:10px;">
          <button id="showRegister" class="btn" style="padding:8px 10px;margin-left:6px;">Register</button>
        </div>
      </div>
      <!-- Register inputs will be added inline here -->
    </div>

    <div style="display:flex;gap:8px;align-items:center;">
      <div id="userStatus" style="color:#bffef1;">Not logged in</div>
      <button id="profileBtn" class="btn" style="display:none;">üë§ Profile</button>
      <button id="logoutBtn" class="btn" style="display:none;">üö™ Logout</button>
    </div>
  </div>

  <div class="season-info">
    <h3>Cycle <span id="seasonDay">1</span></h3>
    <p>Galactic Cycle ends in: <span id="seasonTimer">29d 23h 59m</span></p>
  </div>

  <div class="stats-bar">
    <div class="stat"><div class="stat-label">Crystal Points</div><div class="stat-value" id="applePoints">0</div></div>
    <div class="stat"><div class="stat-label">Credits</div><div class="stat-value" id="gold">100</div></div>
  </div>

  <div class="controls">
    <button class="btn" id="plantAllBtn">üöÄ Deploy All Drones (<span id="plantCost">0</span> cr)</button>
    <button class="btn" id="harvestAllBtn">üíé Collect All Crystals</button>
  </div>

  <div class="farm-grid" id="farmGrid"></div>

  <!-- Upgrades -->
  <div class="upgrades">
    <h3>‚öôÔ∏è Drone & Mining Upgrades</h3>
    <div class="upgrade-item">
      <span class="upgrade-text">‚ö° Faster Mining (Lv <span id="growthLevel">1</span>) <button class="info-btn" data-info="growth">?</button></span>
      <button class="btn" id="growthUpgradeBtn"></button>
    </div>
    <div class="upgrade-item">
      <span class="upgrade-text">üåü High-Yield Extractors (Lv <span id="yieldLevel">1</span>) <button class="info-btn" data-info="yield">?</button></span>
      <button class="btn" id="yieldUpgradeBtn"></button>
    </div>
    <div class="upgrade-item">
      <span class="upgrade-text">üçÄ Cosmic Luck (Lv <span id="luckLevel">1</span>) <button class="info-btn" data-info="luck">?</button></span>
      <button class="btn" id="luckUpgradeBtn"></button>
    </div>
    <div class="upgrade-item">
      <span class="upgrade-text">üõ∞Ô∏è Drone Fleet Capacity (Lv <span id="droneLevel">1</span>) <button class="info-btn" data-info="drone">?</button></span>
      <button class="btn" id="droneUpgradeBtn"></button>
    </div>
    <div class="upgrade-item">
      <span class="upgrade-text">üì¶ Quantum Storage (Lv <span id="storageLevel">1</span>) <button class="info-btn" data-info="storage">?</button></span>
      <button class="btn" id="storageUpgradeBtn"></button>
    </div>
    <div class="upgrade-item">
      <span class="upgrade-text">ü§ñ Autonomous Drone AI (Permanent) <button class="info-btn" data-info="autodeploy">?</button></span>
      <button class="btn" id="autoDeployBtn">Buy (5000 cr)</button>
    </div>
  </div>

  <!-- Research -->
  <div class="upgrades">
    <h3>üî¨ Research Lab</h3>
    <div class="upgrade-item">
      <span class="upgrade-text">ü™ê Terraform Expansion (Plots <span id="researchPlots">0</span>) <button class="info-btn" data-info="plots">?</button></span>
      <button class="btn" id="researchPlotBtn"></button>
    </div>
    <div class="upgrade-item">
      <span class="upgrade-text">üî• Deep Core Drilling (Lv <span id="deepLevel">0</span>) <button class="info-btn" data-info="deep">?</button></span>
      <button class="btn" id="deepUpgradeBtn"></button>
    </div>
    <div class="upgrade-item">
      <span class="upgrade-text">üëΩ Xeno Trade Pact (Lv <span id="tradeLevel">0</span>) <button class="info-btn" data-info="trade">?</button></span>
      <button class="btn" id="tradeUpgradeBtn"></button>
    </div>
  </div>

  <!-- Exchange -->
  <div class="exchange">
    <h3>üè¶ Galactic Exchange</h3>
    <p>Swap 100 Crystal Points ‚Üí <span id="exchangeRate">30</span> Credits <button class="info-btn" data-info="exchange">?</button></p>
    <div id="crashTimer"></div>
    <div class="exchange-buttons">
      <button class="btn" id="exchangeBtn">Exchange 100</button>
      <button class="btn" id="exchange1000Btn">Exchange 1000</button>
      <button class="btn" id="exchangeMaxBtn">Exchange Max</button>
    </div>
  </div>
</div>

<!-- Notification container -->
<div class="notification-container" id="notificationContainer"></div>

<!-- Info modal -->
<div class="modal" id="infoModal"><div class="modal-content">
  <button class="close-modal" id="closeInfo">‚úñ</button>
  <h2 id="modalTitle"></h2>
  <p id="modalText" style="margin-top:8px;color:#d9fff7"></p>
</div></div>

<!-- Profile modal (contains notification toggles and change password) -->
<div class="modal" id="profileModal"><div class="modal-content">
  <button class="close-modal" id="closeProfile">‚úñ</button>
  <h2>üë§ Profile</h2>
  <p><strong>Email:</strong> <span id="profileEmailDisplay"></span></p>

  <div class="profile-grid">
    <div>
      <label for="usernameInput">Username</label>
      <input id="usernameInput" type="text" placeholder="Enter username">
      <div style="margin-top:8px;"><button class="btn" id="saveUsernameBtn">Save Username</button></div>
    </div>
    <div>
      <label>Notifications</label>
      <div class="notif-grid">
        <label><input type="checkbox" id="notifManual"> Manual</label>
        <label><input type="checkbox" id="notifAuto"> Auto Farming</label>
        <label><input type="checkbox" id="notifMarket"> Market</label>
        <label><input type="checkbox" id="notifPurchase"> Purchases</label>
        <label><input type="checkbox" id="notifExchange"> Exchanges</label>
        <label><input type="checkbox" id="notifSystem"> System</label>
      </div>
      <div class="muted">Tip: Auto Farming notifications default to OFF to avoid spam.</div>
    </div>
  </div>

  <hr style="border:1px dashed #003233;margin:12px 0;">

  <h3 style="color:#0aff9d;margin:6px 0 8px 0;">üîí Change Password</h3>
  <label style="display:block;text-align:left;margin-top:6px;">Current password</label>
  <input id="currentPassword" type="password" placeholder="Current password">
  <label style="display:block;text-align:left;margin-top:8px;">New password</label>
  <input id="newPassword" type="password" placeholder="New password">
  <div style="margin-top:10px;"><button class="btn" id="changePasswordBtn">Change Password</button></div>
</div></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged,
    updateProfile,
    updatePassword,
    EmailAuthProvider,
    reauthenticateWithCredential
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  // --- Firebase config (keep or replace with your project) ---
  const firebaseConfig = {
    apiKey: "AIzaSyAwk0pIbza8wo22FTHr4Y3unZozmoJBmEg",
    authDomain: "astro-colony-game.firebaseapp.com",
    projectId: "astro-colony-game",
    storageBucket: "astro-colony-game.firebasestorage.app",
    messagingSenderId: "769632164161",
    appId: "1:769632164161:web:6fa1f148e5165477d1a9c0",
    measurementId: "G-XGB57PFGXJ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- Game state (defaults) ---
  window.gameState = {};
  function defaultState(){
    return {
      applePoints:0,
      gold:100,
      plotsOwned:4,
      plots:[],
      autoDeploy:false,
      upgrades:{
        growth:{level:1,cost:500},
        yield:{level:1,cost:750},
        luck:{level:1,cost:1000},
        drone:{level:1,cost:1200},
        storage:{level:1,cost:1500}
      },
      research:{plots:0,plotsCost:2000,deep:0,deepCost:3000,trade:0,tradeCost:5000},
      seasonDay:1,
      seasonEndTime:Date.now()+30*1000, // 30 seconds for testing season end
      lastDayTick:Date.now(),
      marketCrashUntil:0,
      boomUntil:0,
      notificationSettings:{ manual:true, auto:false, market:true, purchase:true, exchange:true, system:true }
    };
  }

  // --- DOM references ---
  const dom = {
    gameContainer: document.getElementById('gameContainer'),
    authContainer: document.getElementById('authContainer'),
    loginForm: document.getElementById('loginForm'),
    authLinks: document.getElementById('authLinks'),
    userStatus: document.getElementById('userStatus'),
    profileBtn: document.getElementById('profileBtn'),
    logoutBtn: document.getElementById('logoutBtn'),

    seasonDay: document.getElementById('seasonDay'),
    seasonTimer: document.getElementById('seasonTimer'),

    applePoints: document.getElementById('applePoints'),
    gold: document.getElementById('gold'),

    plantCost: document.getElementById('plantCost'),
    plantAllBtn: document.getElementById('plantAllBtn'),
    harvestAllBtn: document.getElementById('harvestAllBtn'),

    farmGrid: document.getElementById('farmGrid'),

    growthLevel: document.getElementById('growthLevel'),
    growthUpgradeBtn: document.getElementById('growthUpgradeBtn'),

    yieldLevel: document.getElementById('yieldLevel'),
    yieldUpgradeBtn: document.getElementById('yieldUpgradeBtn'),

    luckLevel: document.getElementById('luckLevel'),
    luckUpgradeBtn: document.getElementById('luckUpgradeBtn'),

    droneLevel: document.getElementById('droneLevel'),
    droneUpgradeBtn: document.getElementById('droneUpgradeBtn'),

    storageLevel: document.getElementById('storageLevel'),
    storageUpgradeBtn: document.getElementById('storageUpgradeBtn'),

    autoDeployBtn: document.getElementById('autoDeployBtn'),

    researchPlots: document.getElementById('researchPlots'),
    researchPlotBtn: document.getElementById('researchPlotBtn'),

    deepLevel: document.getElementById('deepLevel'),
    deepUpgradeBtn: document.getElementById('deepUpgradeBtn'),

    tradeLevel: document.getElementById('tradeLevel'),
    tradeUpgradeBtn: document.getElementById('tradeUpgradeBtn'),

    exchangeRate: document.getElementById('exchangeRate'),
    exchangeBtn: document.getElementById('exchangeBtn'),
    exchange1000Btn: document.getElementById('exchange1000Btn'),
    exchangeMaxBtn: document.getElementById('exchangeMaxBtn'),

    crashTimer: document.getElementById('crashTimer'),

    notificationContainer: document.getElementById('notificationContainer'),

    infoModal: document.getElementById('infoModal'),
    modalTitle: document.getElementById('modalTitle'),
    modalText: document.getElementById('modalText'),
    closeInfo: document.getElementById('closeInfo'),

    profileModal: document.getElementById('profileModal'),
    closeProfile: document.getElementById('closeProfile'),
    profileEmailDisplay: document.getElementById('profileEmailDisplay'),
    usernameInput: document.getElementById('usernameInput'),
    saveUsernameBtn: document.getElementById('saveUsernameBtn'),
    currentPassword: document.getElementById('currentPassword'),
    newPassword: document.getElementById('newPassword'),
    changePasswordBtn: document.getElementById('changePasswordBtn'),

    // notification toggles inside profile
    notifManual: document.getElementById('notifManual'),
    notifAuto: document.getElementById('notifAuto'),
    notifMarket: document.getElementById('notifMarket'),
    notifPurchase: document.getElementById('notifPurchase'),
    notifExchange: document.getElementById('notifExchange'),
    notifSystem: document.getElementById('notifSystem'),
  };

  // --- Inline register form elements ---
  const registerFormDiv = document.createElement('div');
  registerFormDiv.innerHTML = `
    <input id="registerEmail" type="email" placeholder="Email" required style="padding:6px;border-radius:4px;border:1px solid #00f6ff;background:#061021;color:#fff;margin-right:6px;">
    <input id="registerPassword" type="password" placeholder="Password" style="padding:6px;border-radius:4px;border:1px solid #00f6ff;background:#061021;color:#fff;margin-right:6px;">
    <button id="registerSubmit" class="btn" style="padding:8px 10px;">Create</button>
    <button id="showLogin" class="btn" style="margin-left:6px;background:#00f6ff;padding:8px 10px;">Cancel</button>
  `;
  dom.authLinks.appendChild(registerFormDiv);
  registerFormDiv.style.display = 'none'; // Initially hidden

  // --- Info descriptions ---
  const infoData = {
    growth: ["Faster Mining", "Reduce crystal growth time (shorter harvest cycle)."],
    yield: ["High-Yield Extractors", "Gain more base CP per harvest."],
    luck: ["Cosmic Luck", "Chance to double yields occasionally."],
    drone: ["Drone Fleet", "Reduces cost to deploy drones and improves efficiency."],
    storage: ["Quantum Storage", "Adds bonus % CP after harvest via extra storage tech."],
    autodeploy: ["Autonomous Drone AI", "Auto-deploys drones and harvests; permanent purchase."],
    plots: ["Terraform Expansion", "Adds new mining plots to expand production."],
    deep: ["Deep Core Drilling", "Deep mining research improves growth efficiency."],
    trade: ["Xeno Trade Pact", "Improves exchange rate for CP ‚Üí Credits."],
    exchange: ["Galactic Exchange", "Exchange your CP for Credits. Rate is dynamic."]
  };

  // --- Notifications helper (respects settings) ---
  function showNotification(msg, lucky=false, type='manual'){
    if(!window.gameState) return;
    const settings = window.gameState.notificationSettings || { manual:true, auto:false, market:true, purchase:true, exchange:true, system:true };
    if(type && settings[type] === false) return;
    const n = document.createElement('div');
    n.className = 'notification' + (lucky ? ' lucky' : '');
    n.textContent = msg;
    dom.notificationContainer.appendChild(n);
    setTimeout(()=> n.classList.add('show'), 20);
    setTimeout(()=> n.classList.remove('show'), 3000);
    setTimeout(()=> n.remove(), 3500);
  }

  // --- Core mechanics ---

  // Helper function to calculate cost per drone deployment
  function plantCostPer() {
      const baseCost = 50; // Example base cost
      const droneLevelCostReduction = window.gameState.upgrades.drone.level * 0.1; // 10% reduction per drone upgrade level
      return Math.max(10, Math.floor(baseCost * (1 - droneLevelCostReduction))); // Ensure cost doesn't go below a minimum
  }

  // Helper function to calculate exchange rate
  function calcRate() {
      const baseRate = 30; // Default rate
      const tradeBonus = window.gameState.research.trade * 5; // +5 credits per trade research level
      let rate = baseRate + tradeBonus;

      // Adjust rate based on market events
      if (window.gameState.marketCrashUntil > Date.now()) {
          rate *= 0.7; // 30% reduction during crash
      } else if (window.gameState.boomUntil > Date.now()) {
          rate *= 1.3; // 30% increase during boom
      }
      return Math.floor(rate);
  }

  function plantSeed(p){
    const cost = plantCostPer();
    if(!p || p.state !== 'empty' || window.gameState.gold < cost) return 0;
    p.state = 'planted';
    p.plantTime = Date.now();
    // Growth duration: base 30s, reduced by growth level and deep research
    const growthReduction = (window.gameState.upgrades.growth.level - 1) * 0.2; // 20% faster per level
    const deepResearchFactor = 1 - (window.gameState.research.deep * 0.1); // 10% faster per deep research level
    const baseDuration = 30000; // 30 seconds base
    p.growthDuration = Math.max(3000, Math.floor(baseDuration * (1 - growthReduction) * deepResearchFactor));
    window.gameState.gold -= cost;
    if(!window.gameState.autoDeploy) showNotification("üõ∞Ô∏è Drone deployed!", true, 'manual');
    return cost;
  }

  function harvestPlot(p){
    if(p.state !== 'ready') return {cpGain:0, goldGain:0};
    const base = 15;
    const mul = window.gameState.upgrades.yield.level + window.gameState.upgrades.storage.level * 0.2; // Yield + Storage bonus
    const luck = Math.random() < 0.1 * window.gameState.upgrades.luck.level ? 2 : 1; // Chance for double yield
    const cpGain = Math.floor(base * mul * luck);
    const goldGain = Math.floor(cpGain / 2);
    window.gameState.applePoints += cpGain;
    window.gameState.gold += goldGain;
    p.state = 'empty';
    p.plantTime = null;
    if(!window.gameState.autoDeploy) showNotification(`${luck>1 ? 'üå†' : 'üíé'} +${cpGain} CP`, luck>1, 'manual');
    return {cpGain, goldGain};
  }

  function plantAll(){
    const empties = window.gameState.plots.filter(p => p.state === 'empty').length;
    const totalCost = empties * plantCostPer();
    if(window.gameState.gold < totalCost) return;
    window.gameState.plots.filter(p=>p.state==='empty').forEach(p=>plantSeed(p));
    updateUI();
    renderFarm();
  }

  function harvestAll(){
    const ready = window.gameState.plots.filter(p=>p.state==='ready');
    if(ready.length === 0) return;
    let total=0;
    ready.forEach(p=>{
      const r = harvestPlot(p); // harvestPlot suppresses manual notif if autoDeploy true
      total += r.cpGain;
    });
    if(total>0) showNotification(`üíé +${total} CP Collected!`, false, 'manual');
    updateUI();
    renderFarm();
  }

  function buyUpgrade(type){
    const u = window.gameState.upgrades[type];
    if(window.gameState.gold < u.cost) return;
    window.gameState.gold -= u.cost;
    u.level++;
    u.cost = Math.floor(u.cost * 1.5); // Cost scales by 1.5x
    showNotification(`${type.charAt(0).toUpperCase()+type.slice(1)} upgraded!`, true, 'purchase');
    updateUI();
  }

  function buyAutoDeploy(){
    if(window.gameState.autoDeploy) return;
    if(window.gameState.gold < 5000) return;
    window.gameState.gold -= 5000;
    window.gameState.autoDeploy = true;
    showNotification("ü§ñ Autonomous Drone AI activated!", true, 'purchase');
    updateUI();
  }

  function researchPlots(){
    if(window.gameState.applePoints < window.gameState.research.plotsCost) return;
    window.gameState.applePoints -= window.gameState.research.plotsCost;
    window.gameState.research.plots++;
    window.gameState.research.plotsCost = Math.floor(window.gameState.research.plotsCost * 2.0); // Cost doubles
    window.gameState.plots.push({id: window.gameState.plots.length, state:'empty'});
    showNotification("Terraform Expansion complete!", true, 'purchase');
    renderFarm();
    updateUI();
  }

  function researchDeep(){
    if(window.gameState.applePoints < window.gameState.research.deepCost) return;
    window.gameState.applePoints -= window.gameState.research.deepCost;
    window.gameState.research.deep++;
    window.gameState.research.deepCost = Math.floor(window.gameState.research.deepCost * 2.0); // Cost doubles
    showNotification("Deep Core Drilling complete!", true, 'purchase');
    updateUI();
  }

  function researchTrade(){
    if(window.gameState.applePoints < window.gameState.research.tradeCost) return;
    window.gameState.applePoints -= window.gameState.research.tradeCost;
    window.gameState.research.trade++;
    window.gameState.research.tradeCost = Math.floor(window.gameState.research.tradeCost * 2.0); // Cost doubles
    showNotification("Xeno Trade Pact established!", true, 'purchase');
    updateUI();
  }

  function exchangeCP(amount){
    if(window.gameState.applePoints < amount) return;
    const rate = calcRate();
    const goldGain = Math.floor(amount/100 * rate);
    window.gameState.applePoints -= amount;
    window.gameState.gold += goldGain;
    showNotification(`Exchanged ${amount} CP -> ${goldGain} credits`, true, 'exchange');
    updateUI();
  }
  function exchangeCP100(){ exchangeCP(100); }
  function exchangeCP1000(){ exchangeCP(1000); }
  function exchangeCPMax(){
    const count = Math.floor(window.gameState.applePoints/100) * 100; // Exchange in multiples of 100
    if(count > 0) exchangeCP(count);
  }

  // --- Plot update / auto logic ---
  function updatePlots(){
    const elems = dom.farmGrid.querySelectorAll('.plot');
    window.gameState.plots.forEach((p,i)=>{
      const el = elems[i];
      const crop = el.querySelector('.crop');
      crop.textContent = (p.state === 'empty' ? 'üõ∞Ô∏è' : p.state === 'planted' ? '‚õèÔ∏è' : 'üíé');
      el.className = `plot ${p.state}`;
      const bar = el.querySelector('.progress-bar');
      bar.style.display = p.state === 'planted' ? 'block' : 'none';
      if(p.state === 'planted'){
        const prog = Math.min(100, (Date.now() - p.plantTime) / p.growthDuration * 100);
        el.querySelector('.progress-fill').style.width = prog + '%';
        if(Date.now() - p.plantTime >= p.growthDuration) {
          p.state = 'ready';
          // Directly update visual for ready state without re-rendering everything
          el.className = `plot ready`;
          crop.textContent = 'üíé';
        }
      }
    });

    if(window.gameState.autoDeploy){
      let autoHarvestedCP = 0;
      let autoPlantedCount = 0;
      // auto-harvest ready
      window.gameState.plots.filter(p=>p.state==='ready').forEach(p=>{
        const res = harvestPlot(p); // harvestPlot suppresses manual notif if autoDeploy true
        autoHarvestedCP += res.cpGain;
      });
      // auto-plant empties
      window.gameState.plots.filter(p=>p.state==='empty').forEach(p=>{
        const cost = plantSeed(p);
        if(cost > 0) autoPlantedCount++;
      });
      // only show summary if user enabled auto notifications
      if(window.gameState.notificationSettings && window.gameState.notificationSettings.auto){
        if(autoHarvestedCP > 0) showNotification(`ü§ñ Auto-collected ${autoHarvestedCP} CP!`, true, 'auto');
        if(autoPlantedCount > 0) showNotification(`ü§ñ Auto-deployed ${autoPlantedCount} drones!`, true, 'auto');
      }
    }
  }

  // --- UI rendering functions ---
  function renderFarm(){
    dom.farmGrid.innerHTML = '';
    window.gameState.plots.forEach((p, i) => {
      const el = document.createElement('div');
      el.className = `plot ${p.state}`;
      el.onclick = ()=> handlePlot(i);
      const crop = document.createElement('div');
      crop.className = 'crop';
      // Initial state icon
      crop.textContent = (p.state === 'empty' ? 'üõ∞Ô∏è' : p.state === 'planted' ? '‚õèÔ∏è' : 'üíé');
      el.appendChild(crop);
      const bar = document.createElement('div'); bar.className = 'progress-bar';
      const fill = document.createElement('div'); fill.className = 'progress-fill';
      bar.appendChild(fill); el.appendChild(bar);
      dom.farmGrid.appendChild(el);
    });
  }

  function handlePlot(i){
    const p = window.gameState.plots[i];
    if(p.state === 'empty') plantSeed(p);
    else if(p.state === 'ready') harvestPlot(p);
    updateUI();
    renderFarm(); // Re-render to update state display and icons
  }

  function updateUI(){
    dom.applePoints.textContent = window.gameState.applePoints;
    dom.gold.textContent = window.gameState.gold;
    dom.exchangeRate.textContent = calcRate();
    // market timers
    if(Date.now() < window.gameState.marketCrashUntil){
      const rem = window.gameState.marketCrashUntil - Date.now();
      dom.crashTimer.textContent = `‚ö†Ô∏è Crash ends in ${Math.floor(rem/60000)}m ${Math.floor((rem%60000)/1000)}s`;
      dom.crashTimer.className = 'crash';
    } else if(Date.now() < window.gameState.boomUntil){
      const rem = window.gameState.boomUntil - Date.now();
      dom.crashTimer.textContent = `üöÄ Boom ends in ${Math.floor(rem/60000)}m ${Math.floor((rem%60000)/1000)}s`;
      dom.crashTimer.className = 'boom';
    } else {
      dom.crashTimer.textContent = '';
      dom.crashTimer.className = '';
    }

    // upgrades labels and buttons
    dom.growthUpgradeBtn.textContent = `Upgrade (${window.gameState.upgrades.growth.cost} cr)`;
    dom.growthLevel.textContent = window.gameState.upgrades.growth.level;
    dom.growthUpgradeBtn.disabled = window.gameState.gold < window.gameState.upgrades.growth.cost;

    dom.yieldUpgradeBtn.textContent = `Upgrade (${window.gameState.upgrades.yield.cost} cr)`;
    dom.yieldLevel.textContent = window.gameState.upgrades.yield.level;
    dom.yieldUpgradeBtn.disabled = window.gameState.gold < window.gameState.upgrades.yield.cost;

    dom.luckUpgradeBtn.textContent = `Upgrade (${window.gameState.upgrades.luck.cost} cr)`;
    dom.luckLevel.textContent = window.gameState.upgrades.luck.level;
    dom.luckUpgradeBtn.disabled = window.gameState.gold < window.gameState.upgrades.luck.cost;

    dom.droneUpgradeBtn.textContent = `Upgrade (${window.gameState.upgrades.drone.cost} cr)`;
    dom.droneLevel.textContent = window.gameState.upgrades.drone.level;
    dom.droneUpgradeBtn.disabled = window.gameState.gold < window.gameState.upgrades.drone.cost;

    dom.storageUpgradeBtn.textContent = `Upgrade (${window.gameState.upgrades.storage.cost} cr)`;
    dom.storageLevel.textContent = window.gameState.upgrades.storage.level;
    dom.storageUpgradeBtn.disabled = window.gameState.gold < window.gameState.upgrades.storage.cost;

    dom.researchPlotBtn.textContent = `Research (${window.gameState.research.plotsCost} CP)`;
    dom.researchPlots.textContent = window.gameState.research.plots;
    dom.researchPlotBtn.disabled = window.gameState.applePoints < window.gameState.research.plotsCost;

    dom.deepUpgradeBtn.textContent = `Research (${window.gameState.research.deepCost} CP)`;
    dom.deepLevel.textContent = window.gameState.research.deep;
    dom.deepUpgradeBtn.disabled = window.gameState.applePoints < window.gameState.research.deepCost;

    dom.tradeUpgradeBtn.textContent = `Research (${window.gameState.research.tradeCost} CP)`;
    dom.tradeLevel.textContent = window.gameState.research.trade;
    dom.tradeUpgradeBtn.disabled = window.gameState.applePoints < window.gameState.research.tradeCost;

    dom.exchangeBtn.disabled = window.gameState.applePoints < 100;
    dom.exchange1000Btn.disabled = window.gameState.applePoints < 1000;
    dom.exchangeMaxBtn.disabled = window.gameState.applePoints < 100;

    dom.autoDeployBtn.disabled = window.gameState.autoDeploy || window.gameState.gold < 5000;
    dom.autoDeployBtn.textContent = window.gameState.autoDeploy ? "Purchased ‚úì" : "Buy (5000 cr)";

    const empties = window.gameState.plots.filter(p=>p.state==='empty').length;
    dom.plantCost.textContent = empties * plantCostPer();
    dom.plantAllBtn.disabled = (empties === 0 || window.gameState.gold < empties * plantCostPer());
    dom.harvestAllBtn.disabled = window.gameState.plots.every(p => p.state !== 'ready');

    // season display
    dom.seasonDay.textContent = window.gameState.seasonDay;
    const rem = window.gameState.seasonEndTime - Date.now();
    if(rem > 0){
      const d = Math.floor(rem / 86400000);
      const h = Math.floor((rem % 86400000) / 3600000);
      const m = Math.floor((rem % 3600000) / 60000);
      dom.seasonTimer.textContent = `${d}d ${h}h ${m}m`;
    } else {
      dom.seasonTimer.textContent = "Ended!"; // Handle cases where timer is zero or negative
    }

    // update profile notification toggles if modal is open
    if(dom.notifManual) dom.notifManual.checked = !!window.gameState.notificationSettings.manual;
    if(dom.notifAuto) dom.notifAuto.checked = !!window.gameState.notificationSettings.auto;
    if(dom.notifMarket) dom.notifMarket.checked = !!window.gameState.notificationSettings.market;
    if(dom.notifPurchase) dom.notifPurchase.checked = !!window.gameState.notificationSettings.purchase;
    if(dom.notifExchange) dom.notifExchange.checked = !!window.gameState.notificationSettings.exchange;
    if(dom.notifSystem) dom.notifSystem.checked = !!window.gameState.notificationSettings.system;
  }

  // --- Random Events ---
  function randomEvent(){
    const r = Math.random();
    if(r < 0.05){ // Meteor strike (reduced probability)
      const p = window.gameState.plots.find(p=>p.state==='planted');
      if(p){
        p.state = 'empty';
        p.plantTime = null; // Reset plant time
        showNotification("‚òÑÔ∏è Meteor strike! A drone was lost.", false, 'system');
      }
    } else if(r < 0.30){ // Trader gift (increased probability)
      const g = 200 + Math.floor(Math.random()*200);
      window.gameState.gold += g;
      showNotification(`üëΩ Space Trader gifted +${g} credits!`, true, 'system');
    } else if(r < 0.55){ // Comet delivery (increased probability)
      const cp = 150 + Math.floor(Math.random()*150);
      window.gameState.applePoints += cp;
      showNotification(`üåå Comet arrived with +${cp} CP!`, true, 'system');
    }
    // Market events (crash/boom) are handled directly in updateGameTick for simplicity with timing
  }

  // --- Game loop tick ---
  let gameInterval; // Declare gameInterval here so it's accessible globally

  function updateGameTick(){
    updatePlots();
    updateUI();
    // season tick
    if(Date.now() >= window.gameState.seasonEndTime){
      window.gameState.seasonDay++;
      // For testing, keep season short: 5 minutes
      // For production, you'd want this to be 24 hours or more.
      // For example: window.gameState.seasonEndTime = Date.now() + 24 * 60 * 60 * 1000;
      window.gameState.seasonEndTime = Date.now() + 5 * 60 * 1000; // 5 minute cycle for testing
      showNotification(`Day ${window.gameState.seasonDay}!`, true, 'system');

      // Execute random events
      randomEvent();

      // Market events (crash/boom)
      const rand = Math.random();
      if(rand < 0.1){ // 10% chance of crash
        window.gameState.marketCrashUntil = Date.now() + 30 * 1000; // Crash for 30 seconds
        showNotification("Market Crash!", false, 'market');
      }
      else if(rand < 0.15){ // 5% chance of boom (after crash chance)
        window.gameState.boomUntil = Date.now() + 30 * 1000; // Boom for 30 seconds
        showNotification("Market Boom!", true, 'market');
      }
    }
  }

  function startGameLoop(){
    if(gameInterval) clearInterval(gameInterval); // Clear existing interval if any
    gameInterval = setInterval(updateGameTick, 1000); // Tick every second
  }

  // --- Persistence (Firestore) ---
  async function saveGame(){
    const user = auth.currentUser;
    if(!user) return;
    try{
      // Ensure seasonEndTime is saved correctly for resuming timers
      const gameStateToSave = JSON.parse(JSON.stringify(window.gameState)); // Deep copy
      await setDoc(doc(db, "gamestates", user.uid), gameStateToSave);
      console.log("Saved game");
    } catch(err){ console.error("Save failed:", err); }
  }

  async function loadGame(uid){
    try{
      const snap = await getDoc(doc(db, "gamestates", uid));
      if(snap.exists()){
        window.gameState = snap.data();
        // Ensure compatibility with older save states by filling in missing keys
        const defaults = defaultState();
        // Merge defaults, ensuring nested objects like upgrades and research are also merged
        window.gameState = { ...defaults, ...window.gameState };
        for (const key in defaults) {
            if (typeof defaults[key] === 'object' && defaults[key] !== null && !Array.isArray(defaults[key])) {
                window.gameState[key] = { ...defaults[key], ...(window.gameState[key] || {}) };
            }
        }

        // Ensure notification settings are always present
        if (!window.gameState.notificationSettings) {
            window.gameState.notificationSettings = defaults.notificationSettings;
        }

        // Ensure plots are initialized if somehow missing or incomplete
        if (!window.gameState.plots || window.gameState.plots.length === 0) {
            const plotsToInitialize = window.gameState.plotsOwned || 4;
            window.gameState.plots = [];
            for(let i=0; i < plotsToInitialize; i++) {
                window.gameState.plots.push({id:i, state:'empty'});
            }
        }

        // Calculate remaining time for season
        if(window.gameState.seasonEndTime < Date.now()){
            // If season ended while offline, reset it to start now + duration
            window.gameState.seasonEndTime = Date.now() + 5 * 60 * 1000; // Use testing duration
            window.gameState.seasonDay++; // Increment day if it was past
        }

        initializeUIAfterLoad();
        showNotification("Game loaded!", true, 'system');
        return;
      }
    } catch(err){ console.error("Load failed:", err); }
    // No saved game: initialize defaults
    initializeGame(false);
  }

  // --- Auth functions ---
  async function registerUser(email, password){
    try{
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await updateProfile(cred.user, { displayName: '' }); // Set initial empty display name
      showNotification("Registered & logged in: " + cred.user.email, true, 'system');
    } catch(err){ showNotification("Registration failed: " + err.message, false, 'system'); }
  }

  async function loginUser(email, password){
    try{
      await signInWithEmailAndPassword(auth, email, password);
      showNotification("Logged in!", true, 'system');
    } catch(err){ showNotification("Login failed: " + err.message, false, 'system'); }
  }

  async function logoutUser(){
    try{ await signOut(auth); showNotification("Logged out.", true, 'system'); }
    catch(err){ showNotification("Logout failed: " + err.message, false, 'system'); }
  }

  // --- Profile / change password ---
  async function saveUsername(){
    const user = auth.currentUser;
    if(!user) { showNotification("Not signed in", false, 'system'); return; }
    const newName = dom.usernameInput.value.trim();
    if(!newName){ showNotification("Username cannot be empty", false, 'system'); return; }
    try{
      await updateProfile(user, { displayName: newName });
      dom.userStatus.textContent = `Logged in as: ${user.displayName || user.email}`;
      showNotification("Username updated", true, 'system');
      dom.profileModal.style.display = 'none';
    } catch(err){ showNotification("Update failed: " + err.message, false, 'system'); }
  }

  async function changePassword(){
    const user = auth.currentUser;
    if(!user){ showNotification("Not signed in", false, 'system'); return; }
    const current = dom.currentPassword.value;
    const next = dom.newPassword.value;
    if(!current || !next){ showNotification("Please fill both password fields.", false, 'system'); return; }
    if(next.length < 6) { showNotification("Password must be at least 6 characters.", false, 'system'); return; }

    try{
      const cred = EmailAuthProvider.credential(user.email, current);
      await reauthenticateWithCredential(user, cred);
      await updatePassword(user, next);
      showNotification("Password updated", true, 'system');
      dom.currentPassword.value = ''; dom.newPassword.value = '';
      dom.profileModal.style.display = 'none'; // Close modal on success
    } catch(err){ showNotification("Password change failed: " + err.message, false, 'system'); }
  }

  // --- UI Initialization & event wiring ---
  function initializeUIAfterLoad(){
    renderFarm();
    updateUI();

    // Auth UI wiring
    document.getElementById('showRegister').addEventListener('click', ()=>{
      registerFormDiv.style.display = 'inline-block';
      dom.loginForm.style.display = 'none';
      dom.authLinks.querySelector('#showRegister').style.display = 'none';
    });
    registerFormDiv.querySelector('#showLogin').addEventListener('click', ()=>{
      registerFormDiv.style.display = 'none';
      dom.loginForm.style.display = 'inline-block';
      dom.authLinks.querySelector('#showRegister').style.display = 'inline-block';
    });
    registerFormDiv.querySelector('#registerSubmit').addEventListener('click', ()=>{
      const email = registerFormDiv.querySelector('#registerEmail').value;
      const pw = registerFormDiv.querySelector('#registerPassword').value;
      if(email && pw) registerUser(email, pw);
    });
    dom.loginForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const email = dom.loginEmail.value;
      const pw = dom.loginPassword.value;
      if(email && pw) loginUser(email, pw);
    });
    dom.logoutBtn.addEventListener('click', ()=> logoutUser());
    dom.profileBtn.addEventListener('click', openProfileModal);

    // Profile modal actions
    dom.saveUsernameBtn.addEventListener('click', saveUsername);
    dom.changePasswordBtn.addEventListener('click', changePassword);

    // Main game buttons
    dom.plantAllBtn.onclick = ()=> { plantAll(); };
    dom.harvestAllBtn.onclick = ()=> { harvestAll(); };

    dom.growthUpgradeBtn.onclick = ()=> { buyUpgrade('growth'); };
    dom.yieldUpgradeBtn.onclick = ()=> { buyUpgrade('yield'); };
    dom.luckUpgradeBtn.onclick = ()=> { buyUpgrade('luck'); };
    dom.droneUpgradeBtn.onclick = ()=> { buyUpgrade('drone'); };
    dom.storageUpgradeBtn.onclick = ()=> { buyUpgrade('storage'); };
    dom.autoDeployBtn.onclick = ()=> { buyAutoDeploy(); };

    dom.researchPlotBtn.onclick = ()=> { researchPlots(); };
    dom.deepUpgradeBtn.onclick = ()=> { researchDeep(); };
    dom.tradeUpgradeBtn.onclick = ()=> { researchTrade(); };

    dom.exchangeBtn.onclick = ()=> { exchangeCP100(); };
    dom.exchange1000Btn.onclick = ()=> { exchangeCP1000(); };
    dom.exchangeMaxBtn.onclick = ()=> { exchangeCPMax(); };

    // info buttons
    document.querySelectorAll('.info-btn').forEach(b=>{
      b.addEventListener('click', (e)=>{
        const key = b.dataset.info;
        const d = infoData[key] || ["Info","No info available."];
        dom.modalTitle.textContent = d[0];
        dom.modalText.textContent = d[1];
        dom.infoModal.style.display = 'flex';
      });
    });
    dom.closeInfo.addEventListener('click', ()=> dom.infoModal.style.display = 'none');
    dom.infoModal.addEventListener('click', (e)=> { if(e.target === dom.infoModal) dom.infoModal.style.display = 'none'; });

    // notification toggles
    if(dom.notifManual) dom.notifManual.addEventListener('change', ()=>{ window.gameState.notificationSettings.manual = dom.notifManual.checked; if(auth.currentUser) saveGame(); });
    if(dom.notifAuto) dom.notifAuto.addEventListener('change', ()=>{ window.gameState.notificationSettings.auto = dom.notifAuto.checked; if(auth.currentUser) saveGame(); });
    if(dom.notifMarket) dom.notifMarket.addEventListener('change', ()=>{ window.gameState.notificationSettings.market = dom.notifMarket.checked; if(auth.currentUser) saveGame(); });
    if(dom.notifPurchase) dom.notifPurchase.addEventListener('change', ()=>{ window.gameState.notificationSettings.purchase = dom.notifPurchase.checked; if(auth.currentUser) saveGame(); });
    if(dom.notifExchange) dom.notifExchange.addEventListener('change', ()=>{ window.gameState.notificationSettings.exchange = dom.notifExchange.checked; if(auth.currentUser) saveGame(); });
    if(dom.notifSystem) dom.notifSystem.addEventListener('change', ()=>{ window.gameState.notificationSettings.system = dom.notifSystem.checked; if(auth.currentUser) saveGame(); });

    // Close profile modal by clicking outside
    dom.profileModal.addEventListener('click', (e)=> {
        if(e.target === dom.profileModal) {
            dom.profileModal.style.display = 'none';
        }
    });

    // Start game loop
    startGameLoop();
  }

  // --- Auth state listener ---
  onAuthStateChanged(auth, (user)=>{
    if(user){
      // Use displayName if available, otherwise fallback to email
      dom.userStatus.textContent = `Logged in as: ${user.displayName || user.email}`;
      dom.profileBtn.style.display = 'inline-block';
      dom.logoutBtn.style.display = 'inline-block';
      dom.authContainer.style.display = 'none';
      loadGame(user.uid);
      if(window.autoSaveInterval) clearInterval(window.autoSaveInterval);
      window.autoSaveInterval = setInterval(()=> saveGame(), 10000); // Save every 10 seconds
    } else {
      dom.userStatus.textContent = 'Not logged in';
      dom.profileBtn.style.display = 'none';
      dom.logoutBtn.style.display = 'none';
      dom.authContainer.style.display = 'block'; // Show login/register UI
      // re-initialize game state for guest session
      initializeGame(false);
      if(window.autoSaveInterval){ clearInterval(window.autoSaveInterval); window.autoSaveInterval = null; }
    }
  });

  // --- Profile modal handler ---
  function openProfileModal(){
    const user = auth.currentUser;
    dom.profileEmailDisplay.textContent = user ? user.email : 'Guest';
    dom.usernameInput.value = user ? (user.displayName || '') : '';
    // update toggles from current gameState, ensuring they exist
    if(window.gameState){
      if (!window.gameState.notificationSettings) { // Ensure settings object exists
          window.gameState.notificationSettings = defaultState().notificationSettings;
      }
      dom.notifManual.checked = !!window.gameState.notificationSettings.manual;
      dom.notifAuto.checked = !!window.gameState.notificationSettings.auto;
      dom.notifMarket.checked = !!window.gameState.notificationSettings.market;
      dom.notifPurchase.checked = !!window.gameState.notificationSettings.purchase;
      dom.notifExchange.checked = !!window.gameState.notificationSettings.exchange;
      dom.notifSystem.checked = !!window.gameState.notificationSettings.system;
    }
    dom.profileModal.style.display = 'flex';
  }

  // --- Initial load ---
  window.addEventListener('load', ()=>{
    // Initialize with default state first, then attempt to load saved data via onAuthStateChanged
    initializeGame(false);
    showNotification("üöÄ Welcome Commander!", true, 'system');
  });
</script>
</body>
</html>